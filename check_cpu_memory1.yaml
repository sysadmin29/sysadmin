---
- hosts: windows
  gather_facts: no # Disable fact gathering to speed up execution
  tasks:
    - name: Get CPU load percentage
      win_shell: (Get-WmiObject Win32_Processor | Measure-Object -Property LoadPercentage -Average).Average
      register: cpu_load_raw

    - name: Set CPU Load Percentage variable
      set_fact:
        cpu_load_percentage: "{{ cpu_load_raw.stdout | float | round(2) }}"

    - name: Get Total and Free Physical Memory (MB)
      win_shell: |
        $os = Get-CimInstance Win32_OperatingSystem
        Write-Output "total={{ [math]::Round($os.TotalVisibleMemorySize / 1024, 2) }}"
        Write-Output "free={{ [math]::Round($os.FreePhysicalMemory / 1024, 2) }}"
      register: mem_output
      
    - name: Set Total and Free Memory facts (MB)
      set_fact:
        total_physical_memory_mb: "{{ mem_output.stdout_lines | select('search', '^total=') | first | regex_replace('^total=', '') | float }}"
        free_physical_memory_mb: "{{ mem_output.stdout_lines | select('search', '^free=') | first | regex_replace('^free=', '') | float }}"

    - name: Calculate Used Memory and Usage Percentage (safe)
      set_fact:
        used_physical_memory_mb: "{{ (total_physical_memory_mb - free_physical_memory_mb) | round(2) }}"
        memory_usage_percentage: >-
          {% if total_physical_memory_mb > 0 %}
          {{ ((total_physical_memory_mb - free_physical_memory_mb) / total_physical_memory_mb * 100) | round(2) }}
          {% else %}
          0.0
          {% endif %}

    - name: Display CPU load percentage
      debug:
        msg: "CPU Load Percentage: {{ cpu_load_percentage }}%"

    - name: Show memory usage
      debug:
        msg: >
          Total: {{ total_physical_memory_mb }} MB |
          Free: {{ free_physical_memory_mb }} MB |
          Used: {{ used_physical_memory_mb }} MB |
          Usage: {{ memory_usage_percentage }}%
