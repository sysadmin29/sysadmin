---
- hosts: windows
  gather_facts: no
  tasks:
    - name: Get CPU load percentage
      win_shell: (Get-WmiObject Win32_Processor | Measure-Object -Property LoadPercentage -Average).Average
      register: cpu_load_raw

    - name: Set CPU Load Percentage variable
      set_fact:
        cpu_load_percentage: "{{ cpu_load_raw.stdout | float | round(2) }}"

    - name: Get free physical memory (in KB)
      win_shell: (Get-WmiObject Win32_OperatingSystem).FreePhysicalMemory
      register: free_mem_raw

    - name: Set Free Physical Memory variable (in MB)
      set_fact:
        free_physical_memory_mb: "{{ (free_mem_raw.stdout | int / 1024) | round(2) }}"

    - name: Display CPU load percentage
      debug:
        msg: "CPU Load Percentage: {{ cpu_load_percentage }}%"

    - name: Display free physical memory
      debug:
        msg: "Free Physical Memory: {{ free_physical_memory_mb }} MB"

    - name: Check CPU load percentage # (Example: fail if > 80%)
      assert:
        that:
          - cpu_load_percentage <= 80
        fail_msg: "CPU usage ({{ cpu_load_percentage }}%) exceeds threshold (80%)." # Quoted
        success_msg: "CPU usage ({{ cpu_load_percentage }}%) is within threshold." # Quoted

    - name: Check memory usage # (Example: fail if free memory < 1024 MB)
      assert:
        that:
          - free_physical_memory_mb >= 1024
        fail_msg: "Free physical memory ({{ free_physical_memory_mb }} MB) is below threshold (1024 MB)." # Quoted
        success_msg: "Free physical memory ({{ free_physical_memory_mb }} MB) is above threshold." # Quoted
