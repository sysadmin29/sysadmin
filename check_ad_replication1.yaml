---
- name: Gather replication summary from all DCs
  hosts: windows
  gather_facts: no

  tasks:

    - name: Run repadmin /replsummary
      win_command: repadmin /replsummary
      register: repl_summary
      changed_when: false

    - name: Extract DC lines only
      set_fact:
        repl_lines: "{{ repl_summary.stdout_lines
                        | map('regex_replace', '^[ \t]+', '')
                        | select('match', '^(AURA-DC|[A-Za-z0-9.-]+)[ \t]+[0-9]')
                        | list }}"

    - name: Aggregate all results
      set_fact:
        all_repl: "{{ hostvars
                      | dict2items
                      | map(attribute='value.repl_lines')
                      | select('defined')
                      | sum(start=[]) }}"
      run_once: true

    - name: Build mapping of DC -> metrics
      set_fact:
        repl_map: >-
          {{
            dict(
              all_repl
              | map('regex_replace', '^([A-Za-z0-9.-]+)[ \t]+(.*)', '\\1|\\2')
              | map('split', '|', 2)
            )
          }}
      run_once: true

    - name: Build source and destination lists (mirrored)
      set_fact:
        source_lines: "{{ repl_map.keys() | map('regex_replace', '^(.*)$', '\\1   ' ) | list | zip(repl_map.values() | list) | map('join', '') | list }}"
        dest_lines: "{{ source_lines | reverse }}"
      run_once: true

    - name: Show replication summary (mirrored like AD)
      debug:
        msg: |
          Beginning data collection for replication summary, this may take awhile:
            .....

          Source DSA          largest delta    fails/total %%   error
          {% for line in source_lines %}
           {{ line }}
          {% endfor %}

          Destination DSA     largest delta    fails/total %%   error
          {% for line in dest_lines %}
           {{ line }}
          {% endfor %}
      run_once: true