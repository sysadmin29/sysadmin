---
- name: Check Active Directory Replication
  hosts: windows
  gather_facts: no

  tasks:

    - name: Run repadmin to check replication status
      win_shell: repadmin /replsummary
      register: repl_summary
      ignore_errors: yes

    - name: Parse meaningful summary lines
      set_fact:
        # Filter out headers, empty lines, and lines with '-----'
        repl_lines: "{{ repl_summary.stdout_lines | reject('match','^\\s*(Source|Destination|[-]+|$)') | list }}"

    - name: Split lines into sources and destinations
      set_fact:
        source_lines: "{{ repl_lines[0:2] }}"
        dest_lines: "{{ repl_lines[2:4] }}"

    - name: Show cleaned replication summary (2 sources + 2 destinations)
      debug:
        msg: |
          Source DSA          largest delta    fails/total %%   error
          {% for line in source_lines %}
          {{ line.strip() }}
          {% endfor %}

          Destination DSA     largest delta    fails/total %%   error
          {% for line in dest_lines %}
          {{ line.strip() }}
          {% endfor %}