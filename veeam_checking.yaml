---
- name: Get Veeam Backup Job Status and Restore Point Count (Clean Version)
  hosts: veeam_server
  gather_facts: no
  tasks:

    - name: Run PowerShell to get latest unique backup jobs and restore point count
      ansible.windows.win_powershell:
        script: |
          Add-PSSnapin VeeamPSSnapIn -ErrorAction SilentlyContinue

          # Get all Veeam jobs and their last session
          $jobs = Get-VBRJob | Where-Object { $_.JobType -eq "Backup" -and $_.IsScheduleEnabled -eq $true }

          $jobSummaries = @()

          foreach ($job in $jobs) {
              $sessions = Get-VBRBackupSession | Where-Object { $_.JobName -eq $job.Name } | Sort-Object -Property EndTime -Descending
              $lastSession = $sessions | Select-Object -First 1

              # Skip invalid/empty sessions
              if ($null -eq $lastSession -or $lastSession.EndTime -eq [datetime]'1900-01-01') { continue }

              # Get restore points for the job (unique)
              $restorePoints = (Get-VBRRestorePoint | Where-Object { $_.JobName -eq $job.Name }).Count

              $jobSummaries += [PSCustomObject]@{
                  'Job Name'      = $job.Name
                  'Result'        = $lastSession.Result
                  'StartTime'     = $lastSession.CreationTime.ToString("yyyy-MM-dd HH:mm:ss")
                  'EndTime'       = $lastSession.EndTime.ToString("yyyy-MM-dd HH:mm:ss")
                  'RestorePoints' = $restorePoints
              }
          }

          # Remove duplicates by job name and keep the latest entry only
          $uniqueJobs = $jobSummaries | Sort-Object 'Job Name', EndTime -Descending | Group-Object 'Job Name' | ForEach-Object { $_.Group | Select-Object -First 1 }

          return $uniqueJobs

      register: veeam_status

    - name: Display Veeam backup job status with restore count (unique only)
      debug:
        msg: "{{ veeam_status.output }}"