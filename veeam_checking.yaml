---
- name: Check Veeam Backup & Replication job status
  hosts: veeam_server
  gather_facts: no

  tasks:
    - name: Ensure Veeam PowerShell module is loaded
      win_shell: |
        $modulePath = "C:\Program Files\Veeam\Backup and Replication\Console\Veeam.Backup.PowerShell\Veeam.Backup.PowerShell.psd1"
        if (Test-Path $modulePath) {
            Import-Module $modulePath -ErrorAction Stop
            Write-Output "Veeam PowerShell module loaded successfully."
        } else {
            Write-Error "Veeam PowerShell module not found at $modulePath"
        }

    - name: Get readable Veeam backup job status with restore point count
      win_shell: |
        # Get recent sessions and restore point info
        $sessions = Get-VBRBackupSession | Sort-Object EndTime -Descending | Select-Object -First 10
        $backups = Get-VBRBackup
        $results = @()

        foreach ($session in $sessions) {
            $status = switch ($session.Result.ToString()) {
                "Success" { "Success" }
                "Warning" { "Warning" }
                "Failed"  { "Failed" }
                default   { "Unknown ($($session.Result))" }
            }

            # Match job to backup to get restore points
            $backup = $backups | Where-Object { $_.JobName -eq $session.JobName }
            $restoreCount = if ($backup) { ($backup.GetAllRestorePoints()).Count } else { 0 }

            $results += [PSCustomObject]@{
                "Job Name"      = $session.JobName
                "Result"        = $status
                "RestorePoints" = $restoreCount
                "StartTime"     = $session.CreationTime.ToString("yyyy-MM-dd HH:mm:ss")
                "EndTime"       = $session.EndTime.ToString("yyyy-MM-dd HH:mm:ss")
            }
        }

        $results | ConvertTo-Json -Compress
      register: veeam_jobs

    - name: Display Veeam backup job status with restore count
      debug:
        msg: "{{ veeam_jobs.stdout | from_json }}"