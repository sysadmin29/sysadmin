---
- name: Get Veeam Backup Job Status, Restore Points, Repository, and Type (V12.3)
  hosts: veeam_server
  gather_facts: no
  tasks:

    - name: Run PowerShell to get latest backup job info including repository and type
      ansible.windows.win_powershell:
        script: |
          Add-PSSnapin VeeamPSSnapIn -ErrorAction SilentlyContinue

          $repos = Get-VBRBackupRepository
          $jobs = Get-VBRJob | Where-Object { $_.JobType -eq "Backup" -and $_.IsScheduleEnabled -eq $true }

          $jobSummaries = @()

          foreach ($job in $jobs) {
              $sessions = Get-VBRBackupSession | Where-Object { $_.JobName -eq $job.Name } | Sort-Object EndTime -Descending
              $lastSession = $sessions | Select-Object -First 1
              if ($null -eq $lastSession -or $lastSession.EndTime -eq [datetime]'1900-01-01') { continue }

              $backup = Get-VBRBackup | Where-Object { $_.JobName -eq $job.Name }
              $restoreCount = 0
              if ($backup) {
                  $restoreCount = (Get-VBRRestorePoint -Backup $backup | Measure-Object).Count
              }

              $repository = "Unknown"
              $repoType = "Unknown"

              # âœ… Veeam 12.3 method to get repository name
              try {
                  $targetRepo = $job.GetTargetRepository()
                  if ($targetRepo -ne $null) {
                      $repository = $targetRepo.Name
                      $repoType = $targetRepo.TypeDisplay
                  }
              } catch {
                  # fallback - sometimes Info property still holds repo name
                  try {
                      if ($job.Info.TargetRepositoryName) {
                          $repository = $job.Info.TargetRepositoryName
                          $repoObj = $repos | Where-Object { $_.Name -eq $repository }
                          if ($repoObj) {
                              $repoType = $repoObj.TypeDisplay
                          }
                      }
                  } catch {
                      $repository = "Unknown"
                      $repoType = "Unknown"
                  }
              }

              $jobSummaries += [PSCustomObject]@{
                  'Job Name'      = $job.Name
                  'Result'        = $lastSession.Result.ToString()
                  'StartTime'     = $lastSession.CreationTime.ToString("yyyy-MM-dd HH:mm:ss")
                  'EndTime'       = $lastSession.EndTime.ToString("yyyy-MM-dd HH:mm:ss")
                  'RestorePoints' = $restoreCount
                  'Repository'    = $repository
                  'RepoType'      = $repoType
              }
          }

          $uniqueJobs = $jobSummaries | Sort-Object 'Job Name', EndTime -Descending | Group-Object 'Job Name' | ForEach-Object { $_.Group | Select-Object -First 1 }
          return $uniqueJobs

      register: veeam_status

    - name: Display Veeam backup job status with restore count and repository type
      debug:
        msg: "{{ veeam_status.output }}"